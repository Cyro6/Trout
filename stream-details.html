<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Details</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Existing CSS remains unchanged */
        :root {
            --bg-primary: #D9ECEC;
            --bg-secondary: #e5e7eb;
            --card-bg: white;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --header-bg: #008080;
            --header-hover-bg: #00A0A0;
            --button-bg: #008080;
            --button-hover-bg: #00A0A0;
            --link-color: #008080;
            --link-hover-color: #00A0A0;
            --error-bg: #d6dcf4;
            --table-even-row-bg: #f9fafb;
            --table-hover-bg: #dbeafe;
            --footer-bg: #f8fafc;
            --shadow-color: rgba(0, 0, 0, 0.12);
            --shadow-hover-color: rgba(0, 0, 0, 0.2);
        }

        .dark-theme {
            --bg-primary: #1f2937;
            --bg-secondary: #374151;
            --card-bg: #2d3748;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --header-bg: #3a3c5a;
            --header-hover-bg: #45476b;
            --button-bg: linear-gradient(90deg, #4b5563, #6b7280);
            --button-hover-bg: linear-gradient(90deg, #374151, #4b5563);
            --link-color: #60a5fa;
            --link-hover-color: #93c5fd;
            --error-bg: #4b5563;
            --table-even-row-bg: #374151;
            --table-hover-bg: #4b5563;
            --footer-bg: #2d3748;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --shadow-hover-color: rgba(0, 0, 0, 0.7);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }

        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
        }

        .back-link a {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--link-color);
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .back-link a:hover {
            color: var(--link-hover-color);
            text-decoration: underline;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        .theme-toggle button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-primary);
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .theme-toggle button:hover {
            transform: scale(1.1);
            color: var(--link-hover-color);
        }

        h1 {
            text-align: center;
            font-size: 2.8rem;
            font-weight: 700;
            color: var(--link-color);
            margin-bottom: 1.5rem;
            text-shadow: 0 2px 6px var(--shadow-color);
            animation: fadeIn 1s ease-in;
        }

        h2 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--link-color);
            margin-bottom: 1.2rem;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--card-bg);
            border-radius: 14px;
            box-shadow: 0 6px 25px var(--shadow-color);
            padding: 25px;
            margin: 25px 0;
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px var(--shadow-hover-color);
        }

        .stats, .month-stats, .top-outings, .stream-info, .widnr-map-section, .weather-section, .spots-section {
            margin: 20px 0;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 14px;
            box-shadow: 0 6px 25px var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
        }

        .stream-info p, .weather-section p, .stats p {
            margin: 5px 0;
            color: var(--text-primary);
        }

        .widnr-map-section .toggle-button, .past-weather-toggle, 
        .stream-info-toggle, .month-stats-toggle, .top-outings-toggle,
        .stats-toggle, .weather-toggle, .spots-toggle {
            padding: 10px 20px;
            background: var(--button-bg);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            margin-bottom: 20px;
            display: inline-block;
        }

        .widnr-map-section .toggle-button:hover, .past-weather-toggle:hover, 
        .stream-info-toggle:hover, .month-stats-toggle:hover, .top-outings-toggle:hover,
        .stats-toggle:hover, .weather-toggle:hover, .spots-toggle:hover {
            background: var(--button-hover-bg);
            transform: translateY(-3px);
            box-shadow: 0 4px 15px var(--shadow-hover-color);
        }

        .widnr-map-section .iframe-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            display: none;
        }

        .widnr-map-section .iframe-container.active {
            display: block;
        }

        .widnr-map-section .iframe-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        .widnr-map-section .iframe-fallback {
            margin-top: 10px;
            color: var(--text-secondary);
            display: none;
        }

        .widnr-map-section .iframe-fallback.active {
            display: block;
        }

        .spots-table, .top-outings-table, .month-outing-table, .weather-table {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
        }

        .spots-table th, .spots-table td, .top-outings-table th, .top-outings-table td, 
        .month-outing-table th, .month-outing-table td, .weather-table th, .weather-table td {
            padding: 14px;
            text-align: left;
            border-bottom: 1px solid var(--text-secondary);
            transition: background-color 0.3s ease;
        }

        .spots-table th, .top-outings-table th, .month-outing-table th, .weather-table th {
            background: var(--header-bg);
            color: white;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .spots-table th:hover, .top-outings-table th:hover, .month-outing-table th:hover, .weather-table th:hover {
            background: var(--header-hover-bg);
        }

        .spots-table th .header-content, .top-outings-table th .header-content, 
        .month-outing-table th .header-content, .weather-table th .header-content {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
        }

        .spots-table th .header-icon, .top-outings-table th .header-icon, 
        .month-outing-table th .header-icon, .weather-table th .header-icon {
            font-size: 1.2rem;
        }

        .spots-table th.sort-asc::after, .top-outings-table th.sort-asc::after, 
        .month-outing-table th.sort-asc::after, .weather-table th.sort-asc::after {
            content: ' ‚Üë';
            font-size: 0.9rem;
        }

        .spots-table th.sort-desc::after, .top-outings-table th.sort-desc::after, 
        .month-outing-table th.sort-desc::after, .weather-table th.sort-desc::after {
            content: ' ‚Üì';
            font-size: 0.9rem;
        }

        .spots-table tr:nth-child(even), .top-outings-table tr:nth-child(even), 
        .month-outing-table tr:nth-child(even), .weather-table tr:nth-child(even) {
            background: var(--table-even-row-bg);
        }

        .spots-table tr:hover, .top-outings-table tr:hover, .month-outing-table tr:hover, 
        .weather-table tr:hover {
            background: var(--table-hover-bg);
            transform: scale(1.01);
        }

        .link-icon {
            font-size: 1.2rem;
            color: var(--link-color);
            text-decoration: none;
            transition: color 0.2s ease, transform 0.2s ease;
            display: inline-block;
        }

        .link-icon:hover {
            color: var(--link-hover-color);
            transform: scale(1.1);
        }

        .youtube-icon {
            width: 24px;
            height: 24px;
            vertical-align: middle;
            transition: transform 0.2s ease;
        }

        .youtube-icon:hover {
            transform: scale(1.1);
        }

        .loading, .weather-loading {
            text-align: center;
            font-size: 1.2rem;
            color: var(--text-secondary);
            padding: 25px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .error, .weather-error {
            text-align: center;
            color: #dc2626;
            font-weight: 600;
            padding: 25px;
            background: var(--error-bg);
            border-radius: 8px;
        }

        .filter-section {
            margin: 20px 0;
            padding: 20px;
            background: var(--footer-bg);
            border-radius: 10px;
            border: 1px solid var(--text-secondary);
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-section label {
            font-weight: 600;
            color: var(--text-primary);
            margin-right: 10px;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-section label .icon {
            font-size: 1.2rem;
        }

        .filter-section select, .filter-section input {
            padding: 10px;
            border: 2px solid var(--text-secondary);
            border-radius: 8px;
            font-size: 0.95rem;
            background: var(--card-bg);
            color: var(--text-primary);
            transition: border-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
        }

        .filter-section select:focus, .filter-section input:focus {
            outline: none;
            border-color: var(--link-color);
            box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.25);
            transform: scale(1.02);
        }

        .filter-section select {
            width: 140px;
        }

        .filter-section input {
            width: 90px;
        }

        .filter-section button {
            padding: 10px 20px;
            background: var(--button-bg);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }

        .filter-section button:hover {
            background: var(--button-hover-bg);
            transform: translateY(-3px);
            box-shadow: 0 4px 15px var(--shadow-hover-color);
        }

        .no-results {
            text-align: center;
            color: var(--text-secondary);
            font-size: 1.2rem;
            padding: 25px;
            background: var(--footer-bg);
            border-radius: 8px;
        }

        .month-stats .stats-row {
            display: block;
            overflow: hidden;
        }

        .month-stats .stats-row p {
            margin: 0 0 10px 0;
        }

        .weather-section .current-weather, .weather-section .total-rainfall {
            margin-bottom: 20px;
            padding: 10px;
            background: var(--error-bg);
            border-radius: 8px;
        }

        .weather-section .current-weather p {
            margin: 5px 0;
        }

        .weather-section .weather-location {
            margin: 10px 0;
        }

        .past-weather-container {
            display: none;
        }

        .past-weather-container.active {
            display: block;
        }

        /* Widescreen Layout */
        @media screen and (min-width: 1200px) {
            .stream-details {
                display: flex !important;
                flex-wrap: nowrap !important;
                gap: 2%;
            }
            .stream-details .left-column {
                flex: 0 0 40% !important;
                width: 40% !important;
                box-sizing: border-box;
            }
            .stream-details .right-column {
                flex: 0 0 58% !important;
                width: 58% !important;
                box-sizing: border-box;
                display: block;
                flex-wrap: wrap;
                gap: 20px;
            }
            .info-stats-container {
                display: flex;
                gap: 20px;
            }
            .stream-info, .stats {
                flex: 1;
                min-width: 200px;
            }
            .weather-section, .widnr-map-section {
                width: 100%;
            }
            .spots-section, .month-stats, .top-outings {
                flex: 1;
                min-width: 300px;
            }
            .spots-table, .month-outing-table, .top-outings-table {
                width: 100%;
            }
            .filter-section {
                width: 100%;
            }
        }

        /* Mobile and Narrow Screens */
        @media screen and (max-width: 1199px) {
            .left-column, .right-column,
            .stream-info, .stats, .weather-section, .widnr-map-section,
            .spots-section, .month-stats, .top-outings {
                width: 100%;
                float: none;
            }
            .info-stats-container {
                display: block;
            }
        }

        @media screen and (max-width: 600px) {
            body {
                padding: 12px;
            }

            .back-link, .theme-toggle {
                top: 12px;
                left: 12px;
            }

            .theme-toggle {
                left: auto;
                right: 12px;
            }

            .back-link a, .theme-toggle button {
                font-size: 0.9rem;
            }

            h1 {
                font-size: 2rem;
            }

            h2 {
                font-size: 1.5rem;
            }

            .stats, .month-stats, .top-outings, .stream-info, .widnr-map-section, .weather-section, .spots-section {
                padding: 15px;
                margin: 15px 0;
            }

            .widnr-map-section .iframe-container {
                padding-bottom: 75%;
            }

            .filter-section {
                flex-direction: column;
                flex-wrap: wrap;
                gap: 12px;
                padding: 12px;
                align-items: stretch;
            }

            .filter-section .filter-row {
                display: flex;
                gap: 12px;
                flex-wrap: nowrap;
                width: auto;
            }

            .filter-section .filter-row.button-row {
                width: 100%;
                justify-content: flex-start;
            }

            .filter-section divTM {
                display: flex;
                align-items: center;
            }

            .filter-section label {
                font-size: 0.9rem;
                margin-right: 4px;
            }

            .filter-section select {
                width: 100%;
                font-size: 0.9rem;
                padding: 8px;
            }

            .filter-section input {
                width: 100%;
                font-size: 0.9rem;
                padding: 8px;
            }

            .filter-section button {
                width: 100%;
                font-size: 0.9rem;
                padding: 12px;
            }

            .spots-table, .top-outings-table, .month-outing-table, .weather-table {
                box-shadow: none;
                margin: 15px 0;
            }

            .spots-table {
                display: table !important;
                width: 100%;
                table-layout: fixed;
                font-size: 0.85rem;
            }

            .spots-table thead, .spots-table tbody, .spots-table tr {
                display: table !important;
                width: 100%;
                table-layout: fixed;
            }

            .spots-table th, .spots-table td {
                display: table-cell !important;
                padding: 8px;
                text-align: center;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .spots-table th:nth-child(1), .spots-table td:nth-child(1) {
                width: 15%;
            }

            .spots-table th:nth-child(2), .spots-table td:nth-child(2) {
                width: 15%;
            }

            .spots-table th:nth-child(3), .spots-table td:nth-child(3) {
                width: 20%;
            }

            .spots-table th:nth-child(4), .spots-table td:nth-child(4) {
                width: 20%;
            }

            .spots-table th:nth-child(5), .spots-table td:nth-child(5) {
                width: 30%;
            }

            .top-outings-table thead, .month-outing-table thead, .weather-table thead {
                display: none;
            }

            .top-outings-table tr, .month-outing-table tr, .weather-table tr {
                display: block;
                margin-bottom: 10px;
                border: 1px solid var(--text-secondary);
                border-radius: 8px;
            }

            .top-outings-table td, .month-outing-table td, .weather-table td {
                display: block;
                text-align: right;
                padding: 8px;
                border: none;
                border-bottom: 1px solid var(--text-secondary);
                position: relative;
            }

            .top-outings-table td::before, .month-outing-table td::before, .weather-table td::before {
                content: attr(data-label);
                position: absolute;
                left: 8px;
                width: 45%;
                text-align: left;
                font-weight: bold;
                color: var(--text-primary);
            }

            .top-outings-table td:last-child, .month-outing-table td:last-child, .weather-table td:last-child {
                border-bottom: none;
            }

            .top-outings-table tr:hover, .month-outing-table tr:hover, .weather-table tr:hover {
                background: var(--card-bg);
            }

            .stream-info .stream-info-content,
            .stats .stats-content,
            .weather-section .weather-content,
            .month-stats .month-stats-content,
            .top-outings .top-outings-content,
            .spots-section .spots-content {
                display: none !important;
            }

            .stream-info .stream-info-content.active,
            .stats .stats-content.active,
            .weather-section .weather-content.active,
            .month-stats .month-stats-content.active,
            .top-outings .top-outings-content.active,
            .spots-section .spots-content.active {
                display: block !important;
            }

            .stream-info-toggle,
            .stats-toggle,
            .weather-toggle,
            .month-stats-toggle,
            .top-outings-toggle,
            .spots-toggle {
                display: block !important;
            }

            .spots-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        @media screen and (min-width: 601px) {
            .stream-info .stream-info-content,
            .stats .stats-content,
            .weather-section .weather-content,
            .month-stats .month-stats-content,
            .top-outings .top-outings-content,
            .spots-section .spots-content {
                display: block !important;
            }

            .stream-info-toggle,
            .stats-toggle,
            .weather-toggle,
            .month-stats-toggle,
            .top-outings-toggle,
            .spots-toggle {
                display: none !important;
            }

            .spots-table {
                font-size: 0.95rem;
            }

            .filter-section select {
                width: 140px;
            }

            .filter-section input {
                width: 90px;
            }

            .filter-section .filter-row {
                display: flex;
                gap: 20px;
                flex-wrap: wrap;
            }

            .filter-section .filter-row.button-row {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="theme-toggle">
        <button id="theme-toggle-btn" title="Toggle Theme">‚òÄÔ∏è</button>
    </div>
    <div class="back-link">
        <a href="index.html">‚Üê Back to Dashboard</a>
    </div>
    <h1 id="stream-title">Stream Details</h1>
    <div id="loading" class="loading">Loading Stream Details...</div>
    <div id="error" class="error"></div>

    <div id="stream-details" class="stream-details card" style="display: none;">
        <div class="left-column">
            <div class="info-stats-container">
                <div class="stream-info">
                    <h2>Stream Information</h2>
                    <button class="stream-info-toggle" data-toggle="stream-info-content" onclick="toggleSection('stream-info-content')">Expand</button>
                    <div class="stream-info-content" id="stream-info-content">
                        <p><strong>Regulation:</strong> <span id="stream-regulation"></span></p>
                        <p id="stream-special-regulations-container"><strong>Special Regulations:</strong> <span id="stream-special-regulations"></span></p>
                        <p id="stream-gear-restrictions-container"><strong>Gear Restrictions:</strong> <span id="stream-gear-restrictions"></span></p>
                        <p><strong>Season Information:</strong> <span id="stream-season-info"></span></p>
                        <p><strong>Early Season:</strong> <span id="stream-early-season"></span></p>
                        <p id="stream-widnr-link-container"><strong>WIDNR Map:</strong> <span id="stream-widnr-link"></span> | <span id="stream-widnr-external-link"></span></p>
                    </div>
                </div>
                <div class="stats">
                    <h2>Overall Statistics</h2>
                    <button class="stats-toggle" data-toggle="stats-content" onclick="toggleSection('stats-content')">Collapse</button>
                    <div class="stats-content" id="stats-content">
                        <p><strong>Total Visits:</strong> <span id="total-visits"></span></p>
                        <p><strong>Average Rating:</strong> <span id="avg-rating"></span></p>
                        <p><strong>Most Fished Section (Overall):</strong> <span id="most-fished-section"></span></p>
                    </div>
                </div>
            </div>
            <div class="weather-section">
                <h2 id="weather-title">Weather</h2>
                <button class="weather-toggle" data-toggle="weather-content" onclick="toggleSection('weather-content')">Collapse</button>
                <div class="weather-content" id="weather-content">
                    <div id="weather-loading" class="weather-loading">Loading weather data...</div>
                    <div id="weather-error" class="weather-error"></div>
                    <div class="total-rainfall" id="total-rainfall"></div>
                    <div class="current-weather" id="current-weather"></div>
                    <p class="weather-location" id="weather-location"></p>
                    <button class="past-weather-toggle" data-toggle="past-weather-container" onclick="toggleSection('past-weather-container')">Show Past Weather</button>
                    <div class="past-weather-container" id="past-weather-container">
                        <h3>Past 3 Days Weather</h3>
                        <table class="weather-table" id="past-weather-table">
                            <thead>
                                <tr>
                                    <th title="Date"><div class="header-content"><span class="header-icon">üìÖ</span></div></th>
                                    <th title="Min Temp (¬∞F)"><div class="header-content"><span class="header-icon">üå°Ô∏è</span></div></th>
                                    <th title="Max Temp (¬∞F)"><div class="header-content"><span class="header-icon">üå°Ô∏è</span></div></th>
                                    <th title="Precipitation (in)"><div class="header-content"><span class="header-icon">üíß</span></div></th>
                                    <th title="Max Surface Pressure (hPa)"><div class="header-content"><span class="header-icon">üå¨Ô∏è</span></div></th>
                                    <th title="Wind Direction"><div class="header-content"><span class="header-icon">üß≠</span></div></th>
                                    <th title="Pressure Trend"><div class="header-content"><span class="header-icon">üìà</span></div></th>
                                    <th title="Weather"><div class="header-content"><span class="header-icon">‚õÖ</span></div></th>
                                </tr>
                            </thead>
                            <tbody id="past-weather-body"></tbody>
                        </table>
                    </div>
                    <h3>Forecast (Today and Next 4 Days)</h3>
                    <table class="weather-table" id="forecast-table">
                        <thead>
                            <tr>
                                <th title="Date"><div class="header-content"><span class="header-icon">üìÖ</span></div></th>
                                <th title="Min Temp (¬∞F)"><div class="header-content"><span class="header-icon">üå°Ô∏è</span></div></th>
                                <th title="Max Temp (¬∞F)"><div class="header-content"><span class="header-icon">üå°Ô∏è</span></div></th>
                                <th title="Precipitation (in)"><div class="header-content"><span class="header-icon">üíß</span></div></th>
                                <th title="Max Surface Pressure (hPa)"><div class="header-content"><span class="header-icon">üå¨Ô∏è</span></div></th>
                                <th title="Wind Direction"><div class="header-content"><span class="header-icon">üß≠</span></div></th>
                                <th title="Pressure Trend"><div class="header-content"><span class="header-icon">üìà</span></div></th>
                                <th title="Weather"><div class="header-content"><span class="header-icon">‚õÖ</span></div></th>
                            </tr>
                        </thead>
                        <tbody id="forecast-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="widnr-map-section" id="widnr-map-section">
                <h2>WIDNR Map</h2>
                <button class="toggle-button" onclick="toggleMap()">Expand Map</button>
                <div id="stream-widnr-iframe" class="iframe-container"></div>
                <div id="stream-widnr-fallback" class="iframe-fallback"></div>
            </div>
        </div>

        <div class="right-column">
            <div class="spots-section">
                <h2>Fishing Spots (Downstream to Upstream)</h2>
                <button class="spots-toggle" data-toggle="spots-content" onclick="toggleSection('spots-content')">Collapse</button>
                <div class="spots-content" id="spots-content">
                    <div class="filter-section">
                        <div class="filter-row">
                            <div>
                                <label for="section-filter"><span class="icon">üìç</span> Section:</label>
                                <select id="section-filter" onchange="applyFilters()">
                                    <option value="All">All</option>
                                    <option value="L">L</option>
                                    <option value="M">M</option>
                                    <option value="U">U</option>
                                    <option value="UNK">UNK</option>
                                </select>
                            </div>
                            <div>
                                <label for="visits-filter"><span class="icon">üë£</span> Visits:</label>
                                <input type="number" id="visits-filter" min="0" value="" placeholder="Min Visits" oninput="applyFilters()">
                            </div>
                            <div>
                                <label for="rating-filter"><span class="icon">‚≠ê</span> AR:</label>
                                <input type="number" id="rating-filter" min="0" max="6" step="0.1" value="" placeholder="Min AR" oninput="applyFilters()">
                            </div>
                        </div>
                        <div class="filter-row button-row">
                            <button onclick="clearFilters()">Clear Filters</button>
                        </div>
                    </div>
                    <div id="no-results" class="no-results" style="display: none;">No spots match the filters.</div>
                    <div class="spots-table-container">
                        <table class="spots-table" id="spots-table">
                            <thead>
                                <tr>
                                    <th title="Spot" onclick="sortSpotsTable(0)"><div class="header-content"><span class="header-icon">üé£</span></div></th>
                                    <th title="Section" onclick="sortSpotsTable(1)"><div class="header-content"><span class="header-icon">üìç</span></div></th>
                                    <th title="Visits" onclick="sortSpotsTable(2)"><div class="header-content"><span class="header-icon">üë£</span></div></th>
                                    <th title="AR" onclick="sortSpotsTable(3)"><div class="header-content"><span class="header-icon">‚≠ê</span></div></th>
                                    <th title="GML"><div class="header-content"><span class="header-icon">üó∫Ô∏è</span></div></th>
                                </tr>
                            </thead>
                            <tbody id="spots-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="month-stats">
                <h2 id="month-stats-title">Current Month Statistics</h2>
                <button class="month-stats-toggle" data-toggle="month-stats-content" onclick="toggleSection('month-stats-content')">Expand</button>
                <div class="month-stats-content" id="month-stats-content">
                    <div class="stats-row">
                        <p><strong>Typically Fished Section:</strong> <span id="current-month-section"></span></p>
                        <table class="month-outing-table" id="month-outing-table">
                            <thead>
                                <tr>
                                    <th title="Date"><div class="header-content"><span class="header-icon">üìÖ</span></div></th>
                                    <th title="Rating"><div class="header-content"><span class="header-icon">‚≠ê</span></div></th>
                                    <th title="Location"><div class="header-content"><span class="header-icon">üó∫Ô∏è</span></div></th>
                                    <th title="Section"><div class="header-content"><span class="header-icon">üìç</span></div></th>
                                    <th title="YouTube Link"><div class="header-content"><span class="header-icon">üé•</span></div></th>
                                </tr>
                            </thead>
                            <tbody id="month-outing-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="top-outings">
                <h2>Top 5 Highest Rated Outings</h2>
                <button class="top-outings-toggle" data-toggle="top-outings-content" onclick="toggleSection('top-outings-content')">Expand</button>
                <div class="top-outings-content" id="top-outings-content">
                    <table class="top-outings-table" id="top-outings-table">
                        <thead>
                            <tr>
                                <th title="Date"><div class="header-content"><span class="header-icon">üìÖ</span></div></th>
                                <th title="Rating"><div class="header-content"><span class="header-icon">‚≠ê</span></div></th>
                                <th title="Location"><div class="header-content"><span class="header-icon">üó∫Ô∏è</span></div></th>
                                <th title="Section"><div class="header-content"><span class="header-icon">üìç</span></div></th>
                                <th title="YouTube Link"><div class="header-content"><span class="header-icon">üé•</span></div></th>
                            </tr>
                        </thead>
                        <tbody id="top-outings-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_ID = '1vRDZny6ZfKGXJOKIgoRo47knNJmmtDT2WTrNvOmQ0lwUiznaF1McQVgpTUa1kTMUpq5X6c3b888BGwz';
        const SOURCE_GID = '491893533';
        const STREAM_INFO_GID = '1772368131';
        const SOURCE_URL = `https://docs.google.com/spreadsheets/d/e/2PACX-${SHEET_ID}/pub?gid=${SOURCE_GID}&single=true&output=csv`;
        const STREAM_INFO_URL = `https://docs.google.com/spreadsheets/d/e/2PACX-${SHEET_ID}/pub?gid=${STREAM_INFO_GID}&single=true&output=csv`;

        let sourceData = null;
        let streamInfoData = null;
        let spotsData = [];
        let filteredSpotsData = [];
        let sortSpotsColumn = 1;
        let sortSpotsDirection = 1;
        let widnrLink = '';
        let weatherLatitude = null;
        let weatherLongitude = null;

        const sectionOrder = { 'UPPER': 1, 'MIDDLE': 2, 'LOWER': 3, 'UNKNOWN': 4 };
        const sectionMap = {
            'L': 'LOWER',
            'M': 'MIDDLE',
            'U': 'UPPER',
            'UNK': 'UNKNOWN',
            'All': 'All'
        };
        const urlParams = new URLSearchParams(window.location.search);
        const streamName = "Bear Creek";

        const weatherCodeMap = {
            0: "Clear sky",
            1: "Mainly clear",
            2: "Partly cloudy",
            3: "Overcast",
            45: "Fog",
            48: "Depositing rime fog",
            51: "Light drizzle",
            53: "Moderate drizzle",
            55: "Dense drizzle",
            61: "Light rain",
            63: "Moderate rain",
            65: "Heavy rain",
            71: "Light snow",
            73: "Moderate snow",
            75: "Heavy snow",
            80: "Light rain showers",
            81: "Moderate rain showers",
            82: "Heavy rain showers",
            95: "Thunderstorm",
            96: "Thunderstorm with slight hail",
            99: "Thunderstorm with heavy hail"
        };

        function degreesToCardinal(degrees) {
            const directions = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", 
                               "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
            const index = Math.round(degrees / 22.5) % 16;
            return directions[index];
        }

        function formatDate(isoDate) {
            const [year, month, day] = isoDate.split('-');
            return `${month}/${day}/${year}`;
        }

        function getPressureTrend(currentPressure, previousPressure) {
            if (previousPressure === null) return "N/A";
            const deltaHPa = currentPressure - previousPressure;
            if (deltaHPa >= 5) return "Significantly Rising";
            if (deltaHPa >= 1) return "Rising";
            if (deltaHPa > -1) return "Steady";
            if (deltaHPa > -5) return "Falling";
            return "Significantly Falling";
        }

        function calculateTotalRainfall(data) {
            let total = 0;
            for (let i = 1; i < 4; i++) {
                total += data.daily.precipitation_sum[i];
            }
            return total.toFixed(2);
        }

        async function fetchWeatherData(latitude, longitude) {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&daily=precipitation_sum,surface_pressure_max,temperature_2m_min,temperature_2m_max,weather_code,wind_direction_10m_dominant&current=temperature_2m,weather_code,surface_pressure,wind_direction_10m&timezone=America%2FChicago&past_days=4&forecast_days=5&wind_speed_unit=mph&temperature_unit=fahrenheit&precipitation_unit=inch`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                displayWeatherData(data);
            } catch (error) {
                document.getElementById('weather-error').textContent = `Error loading weather data: ${error.message}`;
                document.getElementById('weather-loading').style.display = 'none';
            }
        }

        function displayWeatherData(data) {
            const totalRainfall = document.getElementById('total-rainfall');
            totalRainfall.innerText = `Total Rainfall (Past 3 Days): ${calculateTotalRainfall(data)} inches`;

            const currentWeather = document.getElementById('current-weather');
            const currentTemp = data.current.temperature_2m.toFixed(1);
            const currentPressure = data.current.surface_pressure.toFixed(1);
            const currentWindDir = degreesToCardinal(data.current.wind_direction_10m);
            const currentWeatherDesc = weatherCodeMap[data.current.weather_code] || "Unknown";
            currentWeather.innerHTML = `
                <p><strong>Temperature:</strong> ${currentTemp}¬∞F</p>
                <p><strong>Pressure:</strong> ${currentPressure} hPa</p>
                <p><strong>Wind Direction:</strong> ${currentWindDir}</p>
                <p><strong>Weather:</strong> ${currentWeatherDesc}</p>
            `;

            const weatherLocation = document.getElementById('weather-location');
            if (weatherLatitude && weatherLongitude) {
                weatherLocation.innerHTML = `<strong>Location:</strong> <a href="https://www.google.com/maps?q=${weatherLatitude},${weatherLongitude}" target="_blank">View on Google Maps</a>`;
            } else {
                weatherLocation.innerText = 'Location: N/A';
            }

            const pastTableBody = document.getElementById('past-weather-body');
            pastTableBody.innerHTML = '';
            for (let i = 1; i < 4; i++) {
                const previousPressure = data.daily.surface_pressure_max[i - 1];
                const pressureTrend = getPressureTrend(data.daily.surface_pressure_max[i], previousPressure);
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td data-label="Date">${formatDate(data.daily.time[i])}</td>
                    <td data-label="Min Temp (¬∞F)">${data.daily.temperature_2m_min[i].toFixed(1)}</td>
                    <td data-label="Max Temp (¬∞F)">${data.daily.temperature_2m_max[i].toFixed(1)}</td>
                    <td data-label="Precipitation (in)">${data.daily.precipitation_sum[i].toFixed(2)}</td>
                    <td data-label="Max Surface Pressure (hPa)">${data.daily.surface_pressure_max[i].toFixed(1)}</td>
                    <td data-label="Wind Direction">${degreesToCardinal(data.daily.wind_direction_10m_dominant[i])}</td>
                    <td data-label="Pressure Trend">${pressureTrend}</td>
                    <td data-label="Weather">${weatherCodeMap[data.daily.weather_code[i]] || "Unknown"}</td>
                `;
                pastTableBody.appendChild(row);
            }

            const forecastTableBody = document.getElementById('forecast-body');
            forecastTableBody.innerHTML = '';
            for (let i = 4; i < data.daily.time.length; i++) {
                const previousPressure = i === 4 ? data.daily.surface_pressure_max[i - 1] : data.daily.surface_pressure_max[i - 1];
                const pressureTrend = getPressureTrend(data.daily.surface_pressure_max[i], previousPressure);
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td data-label="Date">${formatDate(data.daily.time[i])}</td>
                    <td data-label="Min Temp (¬∞F)">${data.daily.temperature_2m_min[i].toFixed(1)}</td>
                    <td data-label="Max Temp (¬∞F)">${data.daily.temperature_2m_max[i].toFixed(1)}</td>
                    <td data-label="Precipitation (in)">${data.daily.precipitation_sum[i].toFixed(2)}</td>
                    <td data-label="Max Surface Pressure (hPa)">${data.daily.surface_pressure_max[i].toFixed(1)}</td>
                    <td data-label="Wind Direction">${degreesToCardinal(data.daily.wind_direction_10m_dominant[i])}</td>
                    <td data-label="Pressure Trend">${pressureTrend}</td>
                    <td data-label="Weather">${weatherCodeMap[data.daily.weather_code[i]] || "Unknown"}</td>
                `;
                forecastTableBody.appendChild(row);
            }

            document.getElementById('weather-loading').style.display = 'none';
        }

        function toggleSection(containerId) {
            console.log(`Toggling section: ${containerId}`);
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`Container not found: ${containerId}`);
                return;
            }
            const button = document.querySelector(`[data-toggle="${containerId}"]`);
            if (!button) {
                console.error(`Button not found for container: ${containerId}`);
                return;
            }
            const isExpanded = container.classList.contains('active');
            if (isExpanded) {
                container.classList.remove('active');
                button.textContent = button.classList.contains('past-weather-toggle') ? 'Show Past Weather' : 'Expand';
                console.log(`Collapsed: ${containerId}`);
            } else {
                container.classList.add('active');
                button.textContent = button.classList.contains('past-weather-toggle') ? 'Hide Past Weather' : 'Collapse';
                console.log(`Expanded: ${containerId}`);
            }
        }

        function toggleMap() {
            const iframeContainer = document.getElementById('stream-widnr-iframe');
            const fallback = document.getElementById('stream-widnr-fallback');
            const toggleButton = document.querySelector('.toggle-button');
            const isExpanded = iframeContainer.classList.contains('active');

            if (isExpanded) {
                iframeContainer.classList.remove('active');
                fallback.classList.remove('active');
                toggleButton.textContent = 'Expand Map';
            } else {
                iframeContainer.classList.add('active');
                fallback.classList.add('active');
                toggleButton.textContent = 'Collapse Map';
            }
        }

        function toggleTheme() {
            const body = document.body;
            const themeButton = document.getElementById('theme-toggle-btn');
            body.classList.toggle('dark-theme');
            const isDark = body.classList.contains('dark-theme');
            themeButton.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        async function init() {
            console.log('Initializing Stream Details Page');
            const savedTheme = localStorage.getItem('theme');
            const themeButton = document.getElementById('theme-toggle-btn');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                themeButton.textContent = '‚òÄÔ∏è';
            } else {
                themeButton.textContent = 'üåô';
            }

            themeButton.addEventListener('click', toggleTheme);

            if (!streamName) {
                document.getElementById('error').textContent = 'Error: No stream specified.';
                document.getElementById('loading').style.display = 'none';
                console.error('No stream name provided in URL');
                return;
            }

            document.getElementById('stream-title').textContent = `${streamName} Details`;
            await Promise.all([fetchData(), fetchStreamInfo()]);
            displayStreamDetails();

            if (window.innerWidth <= 600) {
                document.getElementById('stats-content').classList.add('active');
                document.getElementById('weather-content').classList.add('active');
                document.getElementById('spots-content').classList.add('active');
            }
        }

        async function fetchData() {
            try {
                const response = await fetch(SOURCE_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const csvText = await response.text();
                if (!csvText.trim()) throw new Error('Empty CSV data');
                sourceData = parseCSV(csvText);
            } catch (error) {
                document.getElementById('error').textContent = `Error fetching spots data: ${error.message}`;
                console.error(`Fetch data error: ${error.message}`);
            }
        }

        async function fetchStreamInfo() {
            try {
                const response = await fetch(STREAM_INFO_URL);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const csvText = await response.text();
                if (!csvText.trim()) throw new Error('Empty stream info CSV data');
                streamInfoData = parseCSV(csvText);
            } catch (error) {
                document.getElementById('error').textContent = `Error fetching stream info: ${error.message}`;
                console.error(`Fetch stream info error: ${error.message}`);
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            const headers = lines[0].split(',').map(header => header.trim());
            const rows = lines.slice(1).map(line => {
                const values = [];
                let current = '';
                let insideQuotes = false;
                for (let char of line) {
                    if (char === '"') {
                        insideQuotes = !insideQuotes;
                    } else if (char === ',' && !insideQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());
                return values;
            });
            return { headers, rows };
        }

        function applyFilters() {
            const sectionFilter = sectionMap[document.getElementById('section-filter').value];
            const visitsFilter = document.getElementById('visits-filter').value;
            const ratingFilter = document.getElementById('rating-filter').value;

            filteredSpotsData = spotsData.filter(spot => {
                if (sectionFilter !== 'All' && spot.section !== sectionFilter) return false;
                if (visitsFilter !== '' && spot.visits < parseInt(visitsFilter)) return false;
                if (ratingFilter !== '' && (spot.avgRating === 'N/A' || spot.avgRating < parseFloat(ratingFilter))) return false;
                return true;
            });

            sortFilteredSpots();
        }

        function clearFilters() {
            document.getElementById('section-filter').value = 'All';
            document.getElementById('visits-filter').value = '';
            document.getElementById('rating-filter').value = '';
            filteredSpotsData = [...spotsData];
            sortFilteredSpots();
        }

        function sortSpotsTable(colIndex) {
            if (sortSpotsColumn === colIndex) {
                sortSpotsDirection = -sortSpotsDirection;
            } else {
                sortSpotsColumn = colIndex;
                sortSpotsDirection = 1;
            }

            const headers = document.querySelectorAll('.spots-table th');
            headers.forEach((th, index) => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (index === colIndex) {
                    th.classList.add(sortSpotsDirection === 1 ? 'sort-asc' : 'sort-desc');
                }
            });

            sortFilteredSpots();
        }

        function sortFilteredSpots() {
            filteredSpotsData.sort((a, b) => {
                let valueA, valueB;
                if (sortSpotsColumn === 0) {
                    valueA = a.originalIndex;
                    valueB = b.originalIndex;
                    return sortSpotsDirection * (valueA - valueB);
                } else if (sortSpotsColumn === 1) {
                    valueA = sectionOrder[a.section] || 5;
                    valueB = sectionOrder[b.section] || 5;
                    return sortSpotsDirection * (valueA - valueB);
                } else if (sortSpotsColumn === 2) {
                    valueA = a.visits;
                    valueB = b.visits;
                    return sortSpotsDirection * (valueA - valueB);
                } else if (sortSpotsColumn === 3) {
                    valueA = a.avgRating !== 'N/A' ? a.avgRating : -1;
                    valueB = b.avgRating !== 'N/A' ? b.avgRating : -1;
                    return sortSpotsDirection * (valueA - valueB);
                }
                return 0;
            });

            filteredSpotsData.forEach((spot, idx) => {
                spot.index = idx + 1;
            });

            const spotsBody = document.getElementById('spots-body');
            const noResultsDiv = document.getElementById('no-results');
            spotsBody.innerHTML = '';
            if (filteredSpotsData.length === 0) {
                noResultsDiv.style.display = 'block';
            } else {
                noResultsDiv.style.display = 'none';
                filteredSpotsData.forEach(spot => {
                    const tr = document.createElement('tr');
                    const sectionAbbr = spot.section === 'LOWER' ? 'L' : 
                                        spot.section === 'MIDDLE' ? 'M' : 
                                        spot.section === 'UPPER' ? 'U' : 'UNK';
                    tr.innerHTML = `
                        <td data-label="Spot">${spot.originalIndex}</td>
                        <td data-label="Section">${sectionAbbr}</td>
                        <td data-label="Visits">${spot.visits}</td>
                        <td data-label="AR">${spot.avgRating}</td>
                        <td data-label="GML"><a href="https://www.google.com/maps?q=${spot.lat},${spot.lon}" target="_blank" class="link-icon">üó∫Ô∏è</a></td>
                    `;
                    spotsBody.appendChild(tr);
                });
            }
        }

        function displayStreamDetails() {
            const ratingMap = { 'E': 0, 'D': 1, 'C': 2, 'B': 3, 'A': 4, 'S': 5, 'S+': 6 };
            const ratingReverseMap = { 0: 'E', 1: 'D', 2: 'C', 3: 'B', 4: 'A', 5: 'S', 6: 'S+' };
            const excludedStreams = ['Unknown', 'Central Sands', 'Minnesota', 'Southern WI'];

            const streamData = sourceData?.rows
                .filter(row => {
                    if (row.length < 18) return false;
                    const date = new Date(row[0].replace(/(\d+)\/(\d+)\/(\d+)/, '$3-$1-$2'));
                    const stream = row[2]?.trim() || '';
                    const rating = row[17]?.toUpperCase();
                    const section = row[15]?.trim();
                    const validRating = /^[SABCDE]|S+$/.test(rating);
                    const validStream = !excludedStreams.some(excluded => stream.includes(excluded));
                    return stream === streamName && validRating && validStream && !isNaN(date.getTime());
                })
                .map(row => {
                    const date = new Date(row[0].replace(/(\d+)\/(\d+)\/(\d+)/, '$3-$1-$2'));
                    const month = date.toLocaleString('default', { month: 'long' });
                    const stream = row[2]?.trim() || '';
                    const rating = ratingMap[row[17]?.toUpperCase()] ?? -1;
                    const section = row[15]?.trim().toUpperCase() || 'UNKNOWN';
                    const lat = parseFloat(row[12]);
                    const lon = parseFloat(row[13]);
                    const youtubeLink = row[1]?.trim() || '';
                    return { month, stream, rating, section, lat, lon, date, youtubeLink };
                }) || [];

            if (streamData.length === 0) {
                document.getElementById('error').textContent = 'No data found for this stream.';
                document.getElementById('weather-error').textContent = 'No fishing spots available for weather data.';
                document.getElementById('weather-loading').style.display = 'none';
                document.getElementById('weather-location').textContent = 'Location: N/A';
                return;
            }

            if (streamInfoData) {
                const streamInfoRow = streamInfoData.rows.find(row => row[0]?.trim() === streamName);
                if (streamInfoRow) {
                    document.getElementById('stream-regulation').textContent = streamInfoRow[1] || 'N/A';
                    const specialRegulations = streamInfoRow[2] || 'None';
                    const specialRegulationsContainer = document.getElementById('stream-special-regulations-container');
                    if (specialRegulations.toUpperCase() === 'N/A') {
                        specialRegulationsContainer.style.display = 'none';
                    } else {
                        document.getElementById('stream-special-regulations').textContent = specialRegulations;
                        specialRegulationsContainer.style.display = 'block';
                    }
                    const gearRestrictions = streamInfoRow[3] || 'N/A';
                    const gearRestrictionsContainer = document.getElementById('stream-gear-restrictions-container');
                    if (gearRestrictions.toUpperCase() === 'N/A') {
                        gearRestrictionsContainer.style.display = 'none';
                    } else {
                        document.getElementById('stream-gear-restrictions').textContent = gearRestrictions;
                        gearRestrictionsContainer.style.display = 'block';
                    }
                    document.getElementById('stream-season-info').textContent = streamInfoRow[4] || 'N/A';
                    document.getElementById('stream-early-season').textContent = streamInfoRow[5] || 'N/A';
                    widnrLink = streamInfoRow[6]?.trim();
                    const widnrLinkContainer = document.getElementById('stream-widnr-link-container');
                    if (widnrLink) {
                        document.getElementById('stream-widnr-link').innerHTML = `<a href="#widnr-map-section" onclick="toggleMap()">View WIDNR Map</a>`;
                        document.getElementById('stream-widnr-external-link').innerHTML = `<a href="${widnrLink}" target="_blank">View WIDNR Map External Link</a>`;
                        widnrLinkContainer.style.display = 'block';
                        document.getElementById('stream-widnr-iframe').innerHTML = `<iframe src="${widnrLink}" loading="lazy" allowfullscreen></iframe>`;
                        document.getElementById('stream-widnr-fallback').innerHTML = `If the map doesn't load, <a href="${widnrLink}" target="_blank">view WIDNR details here</a>.`;
                    } else {
                        widnrLinkContainer.style.display = 'none';
                        document.getElementById('stream-widnr-iframe').innerHTML = '';
                        document.getElementById('stream-widnr-fallback').textContent = 'N/A';
                    }
                } else {
                    document.getElementById('stream-regulation').textContent = 'N/A';
                    document.getElementById('stream-special-regulations-container').style.display = 'none';
                    document.getElementById('stream-gear-restrictions-container').style.display = 'none';
                    document.getElementById('stream-season-info').textContent = 'N/A';
                    document.getElementById('stream-early-season').textContent = 'N/A';
                    document.getElementById('stream-widnr-link-container').style.display = 'none';
                    document.getElementById('stream-widnr-iframe').innerHTML = '';
                    document.getElementById('stream-widnr-fallback').textContent = 'N/A';
                }
            } else {
                document.getElementById('stream-regulation').textContent = 'Error loading data';
                document.getElementById('stream-special-regulations-container').style.display = 'none';
                document.getElementById('stream-gear-restrictions-container').style.display = 'none';
                document.getElementById('stream-season-info').textContent = 'Error loading data';
                document.getElementById('stream-early-season').textContent = 'Error loading data';
                document.getElementById('stream-widnr-link-container').style.display = 'none';
                document.getElementById('stream-widnr-iframe').innerHTML = '';
                document.getElementById('stream-widnr-fallback').textContent = 'Error loading data';
            }

            const totalVisits = streamData.length;
            const avgRating = streamData.reduce((sum, entry) => sum + entry.rating, 0) / totalVisits;
            const roundedAvg = Math.round(avgRating * 100) / 100;

            const sectionCounts = { LOWER: 0, MIDDLE: 0, UPPER: 0, UNKNOWN: 0 };
            streamData.forEach(entry => {
                sectionCounts[entry.section] = (sectionCounts[entry.section] || 0) + 1;
            });
            const maxCount = Math.max(sectionCounts.LOWER, sectionCounts.MIDDLE, sectionCounts.UPPER);
            const tieCheck = (sectionCounts.LOWER === maxCount ? 1 : 0) +
                             (sectionCounts.MIDDLE === maxCount ? 1 : 0) +
                             (sectionCounts.UPPER === maxCount ? 1 : 0);
            let mostFishedSection = 'Mixed';
            if (maxCount > 0 && tieCheck === 1) {
                if (sectionCounts.LOWER === maxCount) mostFishedSection = 'Lower';
                else if (sectionCounts.MIDDLE === maxCount) mostFishedSection = 'Middle';
                else if (sectionCounts.UPPER === maxCount) mostFishedSection = 'Upper';
            }

            const currentMonth = new Date().toLocaleString('default', { month: 'long' });
            document.getElementById('month-stats-title').textContent = `${currentMonth} Statistics`;
            const currentMonthData = streamData.filter(entry => entry.month === currentMonth);
            const currentMonthSectionCounts = { LOWER: 0, MIDDLE: 0, UPPER: 0, UNKNOWN: 0 };
            currentMonthData.forEach(entry => {
                currentMonthSectionCounts[entry.section] = (currentMonthSectionCounts[entry.section] || 0) + 1;
            });
            const currentMonthMaxCount = Math.max(currentMonthSectionCounts.LOWER, currentMonthSectionCounts.MIDDLE, currentMonthSectionCounts.UPPER);
            const currentMonthTieCheck = (currentMonthSectionCounts.LOWER === currentMonthMaxCount ? 1 : 0) +
                                        (currentMonthSectionCounts.MIDDLE === currentMonthMaxCount ? 1 : 0) +
                                        (currentMonthSectionCounts.UPPER === currentMonthMaxCount ? 1 : 0);
            let currentMonthSection = currentMonthData.length > 0 ? 'Mixed' : `No ${currentMonth} data`;
            if (currentMonthMaxCount > 0 && currentMonthTieCheck === 1) {
                if (currentMonthSectionCounts.LOWER === currentMonthMaxCount) currentMonthSection = 'Lower';
                else if (currentMonthSectionCounts.MIDDLE === currentMonthMaxCount) currentMonthSection = 'Middle';
                else if (currentMonthSectionCounts.UPPER === currentMonthMaxCount) currentMonthSection = 'Upper';
            }

            const bestCurrentMonthOuting = currentMonthData.length > 0 
                ? currentMonthData.reduce((best, current) => {
                      if (best.rating > current.rating) return best;
                      if (best.rating < current.rating) return current;
                      return best.date > current.date ? best : current;
                  })
                : null;
            const monthOutingBody = document.getElementById('month-outing-body');
            monthOutingBody.innerHTML = '';
            if (bestCurrentMonthOuting) {
                const formattedDate = bestCurrentMonthOuting.date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                const ratingLetter = ratingReverseMap[bestCurrentMonthOuting.rating] || 'N/A';
                const googleMapsLink = `<a href="https://www.google.com/maps?q=${bestCurrentMonthOuting.lat},${bestCurrentMonthOuting.lon}" target="_blank" class="link-icon">üó∫Ô∏è</a>`;
                const youtubeLink = bestCurrentMonthOuting.youtubeLink 
                    ? `<a href="${bestCurrentMonthOuting.youtubeLink}" target="_blank" class="link-icon">
                         <svg class="youtube-icon" viewBox="0 0 24 24" fill="var(--link-color)">
                           <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0C.488 3.45.029 5.804 0 12c.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0C23.512 20.55 23.971 18.196 24 12c-.029-6.185-.484-8.54-4.385-8.816zM9 16V8l8 4-8 4z"/>
                         </svg>
                       </a>` 
                    : 'N/A';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td data-label="Date">${formattedDate}</td>
                    <td data-label="Rating">${ratingLetter}</td>
                    <td data-label="Location">${googleMapsLink}</td>
                    <td data-label="Section">${bestCurrentMonthOuting.section}</td>
                    <td data-label="YouTube Link">${youtubeLink}</td>
                `;
                monthOutingBody.appendChild(tr);
            } else {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="5" data-label="Result">No ${currentMonth} outings found.</td>`;
                monthOutingBody.appendChild(tr);
            }

            document.getElementById('total-visits').textContent = totalVisits;
            document.getElementById('avg-rating').textContent = roundedAvg;
            document.getElementById('most-fished-section').textContent = mostFishedSection;
            document.getElementById('current-month-section').textContent = currentMonthSection;

            const sortedOutings = streamData.sort((a, b) => b.rating - a.rating).slice(0, 5);
            const topOutingsBody = document.getElementById('top-outings-body');
            topOutingsBody.innerHTML = '';
            sortedOutings.forEach(outing => {
                const tr = document.createElement('tr');
                const formattedDate = outing.date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                const ratingLetter = ratingReverseMap[outing.rating] || 'N/A';
                const googleMapsLink = `<a href="https://www.google.com/maps?q=${outing.lat},${outing.lon}" target="_blank" class="link-icon">üó∫Ô∏è</a>`;
                const youtubeLink = outing.youtubeLink 
                    ? `<a href="${outing.youtubeLink}" target="_blank" class="link-icon">
                         <svg class="youtube-icon" viewBox="0 0 24 24" fill="var(--link-color)">
                           <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0C.488 3.45.029 5.804 0 12c.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0C23.512 20.55 23.971 18.196 24 12c-.029-6.185-.484-8.54-4.385-8.816zM9 16V8l8 4-8 4z"/>
                         </svg>
                       </a>` 
                    : 'N/A';
                tr.innerHTML = `
                    <td data-label="Date">${formattedDate}</td>
                    <td data-label="Rating">${ratingLetter}</td>
                    <td data-label="Location">${googleMapsLink}</td>
                    <td data-label="Section">${outing.section}</td>
                    <td data-label="YouTube Link">${youtubeLink}</td>
                `;
                topOutingsBody.appendChild(tr);
            });

            const spotsMap = new Map();
            streamData.forEach((entry, index) => {
                if (!isNaN(entry.lat) && !isNaN(entry.lon)) {
                    const lat = Number(entry.lat.toFixed(5));
                    const lon = Number(entry.lon.toFixed(5));
                    const key = `${lat},${lon}`;
                    if (!spotsMap.has(key)) {
                        spotsMap.set(key, { lat, lon, sections: [entry.section], visits: 1, ratings: [entry.rating] });
                    } else {
                        const spot = spotsMap.get(key);
                        spot.sections.push(entry.section);
                        spot.visits += 1;
                        spot.ratings.push(entry.rating);
                    }
                }
            });

            spotsData = Array.from(spotsMap.values()).map(spot => {
                const sectionCounts = { LOWER: 0, MIDDLE: 0, UPPER: 0, UNKNOWN: 0 };
                spot.sections.forEach(section => {
                    sectionCounts[section] = (sectionCounts[section] || 0) + 1;
                });
                let maxCount = 0;
                let selectedSection = 'UNKNOWN';
                for (const [section, count] of Object.entries(sectionCounts)) {
                    if (count > maxCount) {
                        maxCount = count;
                        selectedSection = section;
                    } else if (count === maxCount) {
                        const order = sectionOrder[section] || 5;
                        const currentOrder = sectionOrder[selectedSection] || 5;
                        if (order < currentOrder) {
                            selectedSection = section;
                        }
                    }
                }
                const validRatings = spot.ratings.filter(r => r >= 0);
                const avgRating = validRatings.length > 0
                    ? Math.round((validRatings.reduce((sum, r) => sum + r, 0) / validRatings.length) * 100) / 100
                    : 'N/A';
                return { lat: spot.lat, lon: spot.lon, section: selectedSection, visits: spot.visits, avgRating };
            });

            const lowerSpots = spotsData.filter(spot => spot.section === 'LOWER');
            const upperSpots = spotsData.filter(spot => spot.section === 'UPPER');
            let latitudeSortDirection = 1;

            if (lowerSpots.length > 0 && upperSpots.length > 0) {
                const avgLowerLat = lowerSpots.reduce((sum, spot) => sum + spot.lat, 0) / lowerSpots.length;
                const avgUpperLat = upperSpots.reduce((sum, spot) => sum + spot.lat, 0) / upperSpots.length;
                if (avgLowerLat > avgUpperLat) {
                    latitudeSortDirection = -1;
                }
            } else if (lowerSpots.length > 0 && spotsData.some(spot => spot.section === 'MIDDLE')) {
                const middleSpots = spotsData.filter(spot => spot.section === 'MIDDLE');
                const avgLowerLat = lowerSpots.reduce((sum, spot) => sum + spot.lat, 0) / lowerSpots.length;
                const avgMiddleLat = middleSpots.reduce((sum, spot) => sum + spot.lat, 0) / middleSpots.length;
                if (avgLowerLat > avgMiddleLat) {
                    latitudeSortDirection = -1;
                }
            } else if (upperSpots.length > 0 && spotsData.some(spot => spot.section === 'MIDDLE')) {
                const middleSpots = spotsData.filter(spot => spot.section === 'MIDDLE');
                const avgMiddleLat = middleSpots.reduce((sum, spot) => sum + spot.lat, 0) / middleSpots.length;
                const avgUpperLat = upperSpots.reduce((sum, spot) => sum + spot.lat, 0) / upperSpots.length;
                if (avgMiddleLat > avgUpperLat) {
                    latitudeSortDirection = -1;
                }
            }

            latitudeSortDirection *= -1;

            spotsData.sort((a, b) => {
                const sectionA = sectionOrder[a.section] || 5;
                const sectionB = sectionOrder[b.section] || 5;
                if (sectionA !== sectionB) {
                    return sectionA - sectionB;
                }
                return latitudeSortDirection * (a.lat - b.lat);
            });

            spotsData.forEach((spot, idx) => {
                spot.originalIndex = spotsData.length - idx;
                spot.index = spotsData.length - idx;
            });

            filteredSpotsData = [...spotsData];
            sortFilteredSpots();

            let selectedSpot = null;
            let selectedSection = '';
            selectedSpot = spotsData.find(spot => spot.section === 'MIDDLE');
            if (selectedSpot) {
                selectedSection = 'MIDDLE';
            } else {
                selectedSpot = spotsData.find(spot => spot.section === 'UPPER');
                if (selectedSpot) {
                    selectedSection = 'UPPER';
                } else {
                    selectedSpot = spotsData.find(spot => spot.section === 'LOWER');
                    if (selectedSpot) {
                        selectedSection = 'LOWER';
                    }
                }
            }

            if (selectedSpot) {
                document.getElementById('weather-title').textContent = `Weather for ${streamName} (${selectedSection} Spot)`;
                weatherLatitude = selectedSpot.lat;
                weatherLongitude = selectedSpot.lon;
                fetchWeatherData(selectedSpot.lat, selectedSpot.lon);
            } else {
                document.getElementById('weather-error').textContent = 'No valid fishing spots found for weather data.';
                document.getElementById('weather-loading').style.display = 'none';
                document.getElementById('weather-location').textContent = 'Location: N/A';
            }

            document.getElementById('stream-details').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
